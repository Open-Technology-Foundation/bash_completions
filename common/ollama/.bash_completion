_ollama() {
    local cur prev opts
    COMPREPLY=()
    cur="${COMP_WORDS[COMP_CWORD]}"
    prev="${COMP_WORDS[COMP_CWORD-1]}"

    local commands="serve start create show run stop pull push list ls ps cp rm help"
    local global_opts="-h --help -v --version"

    if [[ ${COMP_CWORD} == 1 ]]; then
        COMPREPLY=($(compgen -W "${commands} ${global_opts}" -- ${cur}))
        return 0
    fi

    case "${prev}" in
        serve|start)
            opts="-h --help"
            ;;
        create)
            opts="-f --file -h --help -q --quantize"
            ;;
        show)
            opts="-h --help --license --modelfile --parameters --system --template -v --verbose"
            if [[ ${cur} != -* ]]; then
                local models=$(ollama list 2>/dev/null | tail -n +2 | awk '{print $1}' | grep -v '^$' 2>/dev/null)
                COMPREPLY=($(compgen -W "${models}" -- ${cur}))
                return 0
            fi
            ;;
        run)
            opts="--format -h --help --hidethinking --insecure --keepalive --nowordwrap --think --verbose"
            if [[ ${cur} != -* ]]; then
                local models=$(ollama list 2>/dev/null | tail -n +2 | awk '{print $1}' | grep -v '^$' 2>/dev/null)
                COMPREPLY=($(compgen -W "${models}" -- ${cur}))
                return 0
            fi
            ;;
        stop)
            opts="-h --help"
            if [[ ${cur} != -* ]]; then
                local models=$(ollama list 2>/dev/null | tail -n +2 | awk '{print $1}' | grep -v '^$' 2>/dev/null)
                COMPREPLY=($(compgen -W "${models}" -- ${cur}))
                return 0
            fi
            ;;
        pull)
            opts="-h --help --insecure"
            ;;
        push)
            opts="-h --help --insecure"
            if [[ ${cur} != -* ]]; then
                local models=$(ollama list 2>/dev/null | tail -n +2 | awk '{print $1}' | grep -v '^$' 2>/dev/null)
                COMPREPLY=($(compgen -W "${models}" -- ${cur}))
                return 0
            fi
            ;;
        list|ls)
            opts="-h --help"
            ;;
        ps)
            opts="-h --help"
            ;;
        cp)
            opts="-h --help"
            if [[ ${cur} != -* ]]; then
                local models=$(ollama list 2>/dev/null | tail -n +2 | awk '{print $1}' | grep -v '^$' 2>/dev/null)
                COMPREPLY=($(compgen -W "${models}" -- ${cur}))
                return 0
            fi
            ;;
        rm)
            opts="-h --help"
            if [[ ${cur} != -* ]]; then
                local models=$(ollama list 2>/dev/null | tail -n +2 | awk '{print $1}' | grep -v '^$' 2>/dev/null)
                COMPREPLY=($(compgen -W "${models}" -- ${cur}))
                return 0
            fi
            ;;
        help)
            COMPREPLY=($(compgen -W "${commands}" -- ${cur}))
            return 0
            ;;
        --file|-f)
            COMPREPLY=($(compgen -f -- ${cur}))
            return 0
            ;;
        --quantize|-q)
            COMPREPLY=($(compgen -W "q4_K_M q4_K_S q5_K_M q5_K_S q8_0" -- ${cur}))
            return 0
            ;;
        --format)
            COMPREPLY=($(compgen -W "json" -- ${cur}))
            return 0
            ;;
        --think)
            COMPREPLY=($(compgen -W "true false high medium low" -- ${cur}))
            return 0
            ;;
        --keepalive)
            COMPREPLY=($(compgen -W "5m 10m 30m 1h" -- ${cur}))
            return 0
            ;;
        *)
            local cmd="${COMP_WORDS[1]}"
            case "${cmd}" in
                show|run|stop|push|rm)
                    if [[ ${cur} != -* ]]; then
                        local models=$(ollama list 2>/dev/null | tail -n +2 | awk '{print $1}' | grep -v '^$' 2>/dev/null)
                        COMPREPLY=($(compgen -W "${models}" -- ${cur}))
                        return 0
                    fi
                    ;;
                cp)
                    if [[ ${cur} != -* ]]; then
                        local models=$(ollama list 2>/dev/null | tail -n +2 | awk '{print $1}' | grep -v '^$' 2>/dev/null)
                        COMPREPLY=($(compgen -W "${models}" -- ${cur}))
                        return 0
                    fi
                    ;;
            esac
            ;;
    esac

    COMPREPLY=($(compgen -W "${opts}" -- ${cur}))
}

complete -F _ollama ollama